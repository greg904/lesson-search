<!DOCTYPE html>
<html>
<head>
<style>
.match {
	position: relative;
}

.highlight {
	position: absolute;
	background: yellow;
	opacity: 0.2;
}
</style>
</head>
<body>
<p>What do you want to search for?</p>
<input type="text" id="query" />
<div id="matches"></div>
<script>
const queryInput = document.getElementById('query')
const matchesDiv = document.getElementById('matches')
let isLooping = false

async function fetchAndUpdate (query) {
	const res = await fetch('http://localhost:3000/' + encodeURIComponent(query))
	const matches = await res.json()

	// Remove all previous results.
	matchesDiv.innerHTML = ''

	// Create new elements.
	for (let match of matches) {
		const image = document.createElement('img')
		image.src = 'index/images/' + match.imageId + '.jpg'
		const highlight = document.createElement('div')
		highlight.classList.add('highlight')
		highlight.style.top = (match.y * 3) + 'px'
		highlight.style.left = (match.x * 3) + 'px'
		highlight.style.width = (match.width * 3) + 'px'
		highlight.style.height = (match.height * 3) + 'px'
		const matchDiv = document.createElement('div')
		matchDiv.classList.add('match')
		matchDiv.appendChild(image)
		matchDiv.appendChild(highlight)
		matchesDiv.appendChild(matchDiv)
	}
}

async function loop() {
	let lastQuery
	let query = queryInput.value
	do {
		await fetchAndUpdate(query)
		lastQuery = query
		query = queryInput.value
	} while (query !== lastQuery)
}

queryInput.addEventListener('input', function () {
	if (isLooping) {
		return
	}
	isLooping = true
	loop()
		.then(() => isLooping = false)
})
</script>
</body>
</html>
